# StratBet API â€” Coletor de Dados de Futebol ao Vivo
>
> MemÃ³ria viva. Atualizado automaticamente apÃ³s qualquer mudanÃ§a e antes de encerrar cada sessÃ£o.

---

## ğŸ¯ Objetivo

Sistema de coleta automatizada de dados de futebol ao vivo via API externa.

- Consulta a API a cada **30 segundos**
- Detecta automaticamente mudanÃ§as de minuto e transiÃ§Ãµes de perÃ­odo (1T â†’ 2T)
- Armazena dados estÃ¡ticos (prÃ©-jogo) em `jogos` e dados dinÃ¢micos (ao vivo) em `snapshots`
- LÃ³gica de deduplicaÃ§Ã£o: ignora snapshots com mesmo minuto e perÃ­odo

---

## ğŸ‘¥ UsuÃ¡rios e Perfis

- Uso interno/tÃ©cnico â€” sem autenticaÃ§Ã£o implementada na fase 1
- Consumidores futuros: Dashboard de anÃ¡lise para apostadores/analistas

---

## âš™ï¸ Regras de NegÃ³cio CrÃ­ticas

### DetecÃ§Ã£o de PerÃ­odo

| CondiÃ§Ã£o | AÃ§Ã£o |
|---|---|
| `tempo_atual > ultimo_tempo` | Minuto novo â†’ **SALVAR** (mesmo perÃ­odo) |
| `tempo_atual < ultimo_tempo` | RegressÃ£o â†’ **SALVAR** (novo perÃ­odo = periodo+1) |
| `tempo_atual == ultimo_tempo` | Duplicado â†’ **IGNORAR** |

### Estado em MemÃ³ria

- DicionÃ¡rio `estadoJogos: Map<jogo_id, { ultimo_tempo, ultimo_periodo }>`
- Se servidor reiniciar â†’ recupera o Ãºltimo snapshot do banco (evita duplicatas)
- Se jogo sumir da resposta da API â†’ remove do estado (jogo encerrado)

### InserÃ§Ã£o de Jogos

- Cada jogo Ã© inserido **UMA ÃšNICA VEZ** na tabela `jogos` (dados estÃ¡ticos/prÃ©-live)
- Snapshots sÃ£o inseridos a cada minuto diferente detectado
- Ãndice `(jogo_id, periodo, tempo)` garante performance nas queries de estado

---

## ğŸ“¦ Stack

- **Backend:** Node.js 20 + NestJS + Fastify + Prisma + PostgreSQL
- **Scheduler:** `@nestjs/schedule` com `@Cron('*/30 * * * * *')` (30 segundos)
- **HTTP Client:** `axios` para chamadas Ã  API externa
- **Logs:** `nestjs-pino` + `pino-pretty` (dev) | NÃ­vel produÃ§Ã£o: `info`
- **MCP:** `db-strat-bet` (configurado no Coolify para consultas ao banco)
- **Infra:** VPS + Coolify | Deploy: GitHub push â†’ auto deploy
- **Timezone:** `America/Sao_Paulo` (UTC-3) â€” obrigatÃ³rio em tudo
- **Frontend:** A definir (fase futura â€” Dashboard de anÃ¡lise)

### Banco de Dados na VPS

- **Projeto Coolify:** `stratbet-pi` (UUID: `dg8okk0g4og8gw488occgckw`)
- **Banco:** `stratbet-pi-db` (UUID: `k0ocooc4c8w8wg808c8gc40w`)
- **Host:** `161.97.181.33:5431`
- **Database:** `stratbet_pi`
- **User:** `stratbet`
- **Status:** âœ… Running

---

## ğŸ—„ï¸ Banco de Dados

### Tabelas

| Tabela | DescriÃ§Ã£o | Registros |
|---|---|---|
| `jogos` | Dados estÃ¡ticos e prÃ©-live do confronto | 1 por jogo |
| `snapshots` | Dados ao vivo capturados por minuto | N por jogo |

### Ãndices de Performance

```sql
-- snapshots
INDEX ON (jogo_id)
INDEX ON (jogo_id, periodo, tempo)  -- Chave para buscar Ãºltimo estado
INDEX ON (capturado_em)
```

### Schema Prisma

ğŸ“„ Localizado em: `backend/src/prisma/schema.prisma`

**Tabela `jogos`** â€” ~70 campos incluindo:

- IdentificaÃ§Ã£o: `id, liga, time_casa, time_visitante`
- Links: `link_betfair, link_superbet, link_bet365`
- EstatÃ­sticas prÃ©: H2H, PPJ, vitÃ³rias, derrotas, mÃ©dias de gols, xG, xGA, clean sheet, BTTS, overs
- Odds prÃ©: casa, visitante, empate, BTTS, over 0.5/1.5/2.5/3.5, over 0.5 HT

**Tabela `snapshots`** â€” ~80 campos incluindo:

- Placar ao vivo, xG ao vivo, PI1/PI2/PI3, APPM, APPM10
- Chutes (total, ao gol, fora), CG, CG10
- Cantos (HT e totais), ataques, ataques perigosos, posse
- CartÃµes (amarelos e vermelhos), Ãºltimo gol, tempo desde Ãºltimo gol
- Odds ao vivo: casa, visitante, empate, BTTS, overs
- Primeiro gol (% histÃ³rico), CG gol marcados

### Scripts de MigraÃ§Ã£o

- `backend/scripts/` â€” Scripts de DDL/DML via Prisma Client (nunca `prisma migrate` em produÃ§Ã£o)

---

## ğŸ”Œ Rotas da API

| MÃ©todo | Rota | DescriÃ§Ã£o | Auth |
|---|---|---|---|
| GET | `/api/coletor/status` | Estado atual dos jogos em memÃ³ria | NÃ£o |
| GET | `/api/jogos` | Lista todos os jogos registrados | NÃ£o |
| GET | `/api/jogos/:id` | Busca jogo + todos os snapshots | NÃ£o |
| GET | `/api/snapshots/jogo/:jogoId` | HistÃ³rico de snapshots de um jogo | NÃ£o |
| GET | `/api/snapshots/jogo/:jogoId/ultimo` | Ãšltimo snapshot de um jogo | NÃ£o |

---

## ğŸ“ Estrutura de Pastas Atual

```
stratbet-api/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”‚   â”œâ”€â”€ schema.prisma        â† Schema completo com jogos + snapshots
â”‚   â”‚   â”‚   â”œâ”€â”€ prisma.service.ts    â† Singleton PrismaClient com log de queries lentas
â”‚   â”‚   â”‚   â””â”€â”€ prisma.module.ts     â† MÃ³dulo global
â”‚   â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”‚   â”œâ”€â”€ coletor/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ coletor.service.ts    â† LÃ³gica central (Cron 30s + controle de estado)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ coletor.controller.ts â† GET /coletor/status
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ coletor.module.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ coletor.types.ts      â† Tipos EstadoJogo, MapaEstadoJogos
â”‚   â”‚   â”‚   â”œâ”€â”€ jogos/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ jogos.service.ts      â† garantirJogoExiste(), listar, buscar
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ jogos.controller.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ jogos.module.ts
â”‚   â”‚   â”‚   â””â”€â”€ snapshots/
â”‚   â”‚   â”‚       â”œâ”€â”€ snapshots.service.ts  â† salvarSnapshot(), listar, buscarUltimo
â”‚   â”‚   â”‚       â”œâ”€â”€ snapshots.controller.ts
â”‚   â”‚   â”‚       â””â”€â”€ snapshots.module.ts
â”‚   â”‚   â”œâ”€â”€ app.module.ts            â† MÃ³dulo raiz com Config, Schedule, Pino
â”‚   â”‚   â””â”€â”€ main.ts                  â† Bootstrap Fastify + Pino
â”‚   â”œâ”€â”€ scripts/                     â† Scripts de migraÃ§Ã£o de banco
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â””â”€â”€ nest-cli.json
â”œâ”€â”€ frontend/                        â† A definir (fase futura)
â”œâ”€â”€ Dockerfile                       â† Multi-stage build
â”œâ”€â”€ .env.example                     â† Template de variÃ¡veis de ambiente
â”œâ”€â”€ .gitignore
â””â”€â”€ CONTEXTO.MD                      â† Este arquivo
```

---

## ğŸ”§ VariÃ¡veis de Ambiente

```env
DATABASE_URL="postgresql://user:password@host:5432/stratbet?schema=public"
TZ=America/Sao_Paulo
PGTZ=America/Sao_Paulo
PORT=3000
NODE_ENV=production
LOG_LEVEL=info
API_FUTEBOL_URL=https://sua-api-futebol.com/jogos-ao-vivo
API_FUTEBOL_TOKEN=
INTERVALO_COLETA_MS=30000
```

---

## ğŸ“‹ IntegraÃ§Ãµes Externas

| IntegraÃ§Ã£o | Tipo | Status |
|---|---|---|
| **FutAlerta API** | GET polling 30s | âœ… URL confirmada e funcionando |
| Betfair | Link externo (ID numÃ©rico no campo) | Campo no banco |
| Superbet | Link externo (URL completa) | Campo no banco |
| Bet365 | Link externo (URL completa) | Campo no banco |

**FutAlerta API:**

- URL: `https://futalerta.com.br/api/in-live?api_token=TOKEN`
- Retorna: array JSON flat com todos os jogos ao vivo
- Token: configurado via `API_FUTEBOL_URL` no `.env`

**Mapeamentos de chaves (API â†’ Banco):**

| Chave na API | Campo no banco |
|---|---|
| `time-casa` | `time_casa` |
| `link-betfair` | `link_betfair` (string) |
| `placar_ht-casa` | `placar_ht_casa` |
| `tempo` | `snapshots.tempo` |
| `total_de_chutes-casa` | `total_chutes_casa` |
| `chutes_fora_do_gol-casa` | `chutes_fora_casa` |
| `posse_de_bola-casa` | `posse_casa` |
| `tempo_desde_o_ultimo_gol-casa` | `tempo_desde_ultimo_gol_casa` |
| `odds_over_2_5_live` | `odds_over_25_live` (âš ï¸ underscore na fonte) |
| `1_gol-casa` | `primeiro_gol_casa` |
| `odds_over_0_5_ht-live` | `odds_over_05_ht_live` |

---

## ğŸš€ Roadmap

- [x] **Fase 1 â€” Setup e Estrutura**
  - [x] Schema Prisma completo (jogos + snapshots)
  - [x] NestJS com Fastify + Pino
  - [x] MÃ³dulo Coletor com Cron de 30s
  - [x] LÃ³gica de detecÃ§Ã£o de perÃ­odo em memÃ³ria
  - [x] RecuperaÃ§Ã£o de estado do banco apÃ³s restart
  - [x] Dockerfile multi-stage
- [ ] **Fase 2 â€” ConfiguraÃ§Ã£o e Testes**
  - [ ] Configurar `.env` com URL da API real
  - [ ] Instalar dependÃªncias (`npm install`)
  - [ ] Configurar banco PostgreSQL na VPS
  - [ ] Criar tabelas (`npx prisma generate` + script de migraÃ§Ã£o)
  - [ ] Testar coleta com jogos reais
- [ ] **Fase 3 â€” Monitoramento**
  - [ ] Dashboard de visualizaÃ§Ã£o dos snapshots
  - [ ] Alertas de falha na coleta
- [ ] **Fase 4 â€” AnÃ¡lise**
  - [ ] MÃ³dulo de anÃ¡lise ao vivo (AI/regras)
  - [ ] ExportaÃ§Ã£o de dados para anÃ¡lise externa

---

## ğŸ“ DecisÃµes TÃ©cnicas

| DecisÃ£o | Motivo |
|---|---|
| NestJS sobre Fastify (puro) | Volume de dados alto, vÃ¡rios mÃ³dulos com responsabilidades distintas |
| Estado em memÃ³ria (`Map`) | Performance mÃ¡xima â€” evita query ao banco a cada 30 segundos |
| RecuperaÃ§Ã£o do banco no startup | ResiliÃªncia apÃ³s restart â€” evita duplicatas e erros de perÃ­odo |
| Todos os campos `nullable` em snapshots | API pode nÃ£o retornar todos os campos sempre |
| `Decimal` para odds e percentuais | Evita erros de ponto flutuante em cÃ¡lculos |
| Ãndice em `(jogo_id, periodo, tempo)` | Query mais comum: buscar Ãºltimo estado do jogo |

---

## âš ï¸ Problemas Conhecidos

- URL da API de futebol ao vivo ainda nÃ£o fornecida pelo usuÃ¡rio
- O mapeamento dos campos da API (`dadosApi.xxx`) depende do formato real da resposta â€” **confirmar com o usuÃ¡rio**
- PerÃ­odo 3 (prorrogaÃ§Ã£o) nÃ£o estÃ¡ explicitamente tratado, mas a lÃ³gica de detecÃ§Ã£o de regressÃ£o funciona genericamente

---

## ğŸ“… Ãšltima SessÃ£o â€” 2026-02-27

**O que foi feito:**

- Planejamento completo do projeto seguindo o fluxo Arquiteto de Projetos
- Schema Prisma criado com 2 tabelas e ~150 campos combinados
- Estrutura NestJS completa: mÃ³dulos Coletor, Jogos, Snapshots
- LÃ³gica central de detecÃ§Ã£o de perÃ­odo e controle de estado implementada
- Dockerfile multi-stage criado
- URL e formato real da API FutAlerta confirmados e mapeados
- Todos os campos corrigidos com as chaves reais da API (hÃ­fens, nomes composto)
- Campo `odds_over_05_ht_live` adicionado ao schema de snapshots

**O que foi testado:** API FutAlerta consultada e respondendo corretamente

**PrÃ³ximos passos:**

1. Configurar `.env` com `DATABASE_URL` apontando para o banco na VPS
2. `cd backend && npm install`
3. Criar script de migraÃ§Ã£o em `backend/scripts/criar-tabelas.ts`
4. `npm run start:dev` para testar a coleta ao vivo

---

## â¡ï¸ PrÃ³ximos Passos

1. **Configurar `.env`** com as credenciais do banco e URL da API
2. **Instalar dependÃªncias:** `cd backend && npm install`
3. **Gerar Prisma Client:** `npx prisma generate --schema=src/prisma/schema.prisma`
4. **Criar as tabelas no banco** via script em `backend/scripts/`
5. **Informar o formato JSON que a API retorna** (para ajustar o mapeamento de campos)
6. **Rodar em dev:** `npm run start:dev`

---

## ğŸ“… HistÃ³rico de MudanÃ§as

| Data | VersÃ£o | MudanÃ§a |
|---|---|---|
| 2026-02-27 | 1.0.0 | Estrutura inicial criada â€” Schema, NestJS, Coletor, Dockerfile |
